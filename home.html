<!DOCTYPE html>
<html>
  <head>
    <title>Chess</title>
    <link rel="stylesheet" href="css/chessboard-0.3.0.min.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <script src="js/chessboard-0.3.0.min.js"></script>
    <script src="js/chess.js"></script>
    <script src="js/notify.min.js"></script>
  </head>
  <body>
   <div class = "row">
      <div class="col-xs-3 col-sm-3 col-md-3 col-lg-3" >
      </div>

      <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6" >
        <div id="board"></div>
        <p>Status: <span id="status"></span></p>

        <button onclick = "Forward()">Forward</button>
        <button onclick = "undoMove()">Back</button>
        <button onclick = "nextPuzzle()">Next Puzzle</button>
</div>
<div class="col-xs-3 col-sm-3 col-md-3 col-lg-3" >
  </div>

      </div>
  </body>


  <script>
    k=0;
var puzzleArray =['6R1/5q1p/3Qp1pk/p3Pp2/Ppr2P2/2P4P/6PK/8 w - - 0 1','rnbqkbnr/ppp1p1pp/8/3p1p2/4P3/2P5/PP1P1PPP/RNBQKBNR w KQkq - 0 3'];
  var board,
  //rnbqkbnr/ppp1p1pp/8/3p1p2/4P3/2P5/PP1P1PPP/RNBQKBNR w KQkq - 0 3
  // original 6R1/5q1p/3Qp1pk/p3Pp2/Ppr2P2/2P4P/6PK/8 w - - 0 1
  game = new Chess(puzzleArray[k]),

  statusEl = $('#status'),
  fenEl = $('#fen'),
  pgnEl = $('#pgn');

  var i =0;
var solutionOne = ['d6d8','c4f4','g2g4','f5g4','d8h4'];
var solutionTwo =['e4d5'];
var allSolutions=[solutionOne,solutionTwo];
//original solution ['d6d8','c4f4','g2g4','f5g4','d8h4'];


// do not pick up pieces if the game is over
// only pick up pieces for the side to move
var onDragStart = function(source, piece, position, orientation) {

  if (game.game_over() === true ||
      (game.turn() === 'w' && piece.search(/^b/) !== -1) ||
      (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
    return false;
  }
};

var onDrop = function(source, target,piece) {

  // see if the move is legal
  var move = game.move({
    from: source,
    to: target,
    piece:piece,
    promotion: 'q' // NOTE: always promote to a queen for example simplicity
  });

  // illegal move



//if (move === null) return 'snapback';
if (move === null) {return 'snapback';}


  else if(move!== null){
var fromSq= move.from;
    var toSq = move.to;
//var thisPiece = move.piece;
//window.alert(thisPiece+sq);

//solution[i].toLowerCase()
// call in a function every time - this breaks code?
// pawn not clarified as a piece


var puzSolution = allSolutions[k][i];
// old method .toLowerCase().replace('x','')
//window.alert(cleanSolution);
//window.alert(fromSq+toSq);
//window.alert((thisPiece+sq+fromsq).replace('p',''));

var incorrectMove = Boolean(fromSq+toSq!==puzSolution);
window.alert(incorrectMove);

  if (incorrectMove){
    game.undo();
    incorrectSolutionAlert();
    // snapback kills process
    return 'snapback';

    }
}
//else if (move === null) return 'snapback';
//shake box?
//notify js
  i+=1;
  $("#board").notify("Correct Solution!");
  updateStatus();
};

var j =0;

function incorrectSolutionAlert(){
  j+=1;
  $("#board").notify("Incorrect Attempt number " + j );
}

// update the board position after the piece snap
// for castling, en passant, pawn promotion
var onSnapEnd = function() {
  board.position(game.fen());
};

var updateStatus = function() {
  var status = '';

  var moveColor = 'White';
  if (game.turn() === 'b') {
    moveColor = 'Black';
  }

  // checkmate?
  if (game.in_checkmate() === true) {
    status = 'Game over, ' + moveColor + ' is in checkmate.';
  }

  // draw?
  else if (game.in_draw() === true) {
    status = 'Game over, drawn position';
  }

  // game still on
  else {
    status = moveColor + ' to move';

    // check?
    if (game.in_check() === true) {
      status += ', ' + moveColor + ' is in check';
    }
  }

  statusEl.html(status);
  fenEl.html(game.fen());
  pgnEl.html(game.pgn());
};

var cfg = {
  draggable: true,
  position: puzzleArray[k],
  onDragStart: onDragStart,
  onDrop: onDrop,
  onSnapEnd: onSnapEnd
};


board = ChessBoard('board', cfg);

updateStatus();



function Forward(){
  //sloppy allows for sq to sq format
  game.move(solution[i], {sloppy: true});

  if(i<solution.length-1)
  {
    i+=1;
  }
  board.position(game.fen());
}


function undoMove(){

if(i>0){i-=1;}
game.undo();
board.position(game.fen());
}

function nextPuzzle(){
k+=1;
  game = new Chess(puzzleArray[k]);
  board.position(game.fen());

}


  </script>


</html>